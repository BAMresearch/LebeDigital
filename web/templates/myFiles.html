{% extends 'base.html' %}

{% block title %}Files{% endblock %}

{% block content %}
<!-- Page-specific content goes here -->
<div class="content p-2 col-12" style="overflow-x: hidden;">
    <!-- Existing content -->

    <h5 class="">
    {% if session['username'] == 'admin' %}
        All files
    {% else %}
        My files
    {% endif %}
    </h5>
    <input type="hidden" id="username" value="{{ session['username'] }}">

    <p>Here you can find all the files (i.e. Mixture, Compressive Strength, E-Modul) that you have uploaded before.</p>

    <div class="container-fluid">
        {% if uploads %}
        <table class="table table-hover">
            <thead>
                <tr class="row">
                    <th class="col-4 clr-theme">File</th>
                    <th class="col-2 clr-theme">Type</th>
                    <th class="col-4 clr-theme">ID</th>
                    <th class="col-2 clr-theme">Uploaded at</th>
                </tr>
            </thead>
            <tbody>
                {% for upload in uploads %}
                <tr class="row small">
                    <td class="col-4" style=" word-wrap: break-word;">
                        <a href="#" onclick="downloadFile('{{ upload['Unique_ID'] }}')" class="{{ 'text-danger' if upload['mapped'] == 0 }}">{{ upload['filename'] }}</a>
                        {% if upload['deletedByUser'] == 1 %}
                            <span class="badge rounded-pill text-danger bg-light-red">Deleted</span>                         
                        {% endif %}
                    </td>
                    <td class="col-2">{{ upload['type'] }}</td>
                    <td class="col-4">{{ upload['Unique_ID'] }}</td>
                    <td class="col-2">
                        {{ upload['uploadDate'] }} Â &nbsp; &nbsp;
                        <a href="#" class="light-red" onclick="deleteFile('{{ upload['Unique_ID'] }}')">
                            <i class="fa fa-trash"></i>
                        </a>
                    </td>
                </tr>                
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center p-5">
            <img src="{{ url_for('static', filename='images/no-content.png') }}" alt="No files">
            <p class="small text-muted">You have not uploaded any files yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!--notify user about deleting-->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #e9fef7; z-index: 1000;">
        <div class="toast-body">
            <i class="fas fa-check-circle text-success"></i>&nbsp;<span id="success-message"></span>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToastError" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #ffcccb; z-index: 1000;">
        <div class="toast-body">
            <i class="fas fa-exclamation-circle text-danger"></i>&nbsp; <span id="error-message"></span>
        </div>
    </div>
</div>

<script>
    function downloadFile(id) {
        fetch(`/rawdownload?id=${encodeURIComponent(id)}`, {
            method: 'GET'
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        }).then(blob => {
            // Erstellt einen Download-Link und klickt darauf
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `${id}.zip`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }).catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    function deleteFile(id) {
    var confirmation = confirm("Are you sure you want to delete this file?");
    if (confirmation) {
        // Get the session username
        var username = document.getElementById('username').value;

        console.log(username)

        // Determine the endpoint to call based on the username
        var endpoint = (username === 'admin') ? '/adminData' : '/updateDeletedByUser';

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                removeFile: id
            }),
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === 200) {
                document.getElementById("success-message").innerHTML = data.message
                const toastLiveExample = document.getElementById('liveToast')
                const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
                toastBootstrap.show()  
            } else {
                document.getElementById("error-message").innerHTML = 'Something went wrong!'
                const toastLiveExample = document.getElementById('liveToastError')
                const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
                toastBootstrap.show()
            }
            // Refresh the page after a delay
            setTimeout(function() {
                location.reload();
            }, 2000);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
}


</script>
{% endblock %}
